<!DOCTYPE html>
<html>
  <head>
    <!-- using bootstrap 4.3.1 -->
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta http-equiv="X-UA-Compatible" content="ie=edge" />
    <link rel="stylesheet" href="css/bootstrap.min.css" />
    <link rel="stylesheet" href="css/custom.css" />
    <link
      href="https://fonts.googleapis.com/css?family=Roboto&display=swap"
      rel="stylesheet"
    />
    <!-- import logo Rsquare and Head -->
    <link rel="icon" href="images/logo/Artboard 1logo.png" />
    <script src="js/jquery-3.4.1.js"></script>
    <script src="js/popper.min.js"></script>
    <script src="js/bootstrap.min.js"></script>
    <script src="js/custom.js"></script>
    <title>R-SQUARE</title>

    
    <link href="MDB-Free/css/style.css" rel="stylesheet">

    <!-- JQuery -->
    
    <!-- MDB core JavaScript -->
    <script type="text/javascript" src="MDB-Free/js/mdb.min.js"></script>
    <!--CSS-->
    <link
      rel="stylesheet"
      href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css"
      integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T"
      crossorigin="anonymous"
    />
  </head>
  <body>
    <!-- /Head of the Card -->
    <div class="container">
      <div class="container-content">
        <div class="row justify-content-center"><h1 class="vdark-blue">View User</h1></div>
        <div class="card-content">                   
          <div class="row">
            <h4 class="font-weight-bold text-lg-left text-primary">Responsible Place</h4>
            <table class="table">
              <thead>
                <tr>
                  <th scope="col">Building</th>
                  <th scope="col">Floor</th>
                  <th scope ="col">Place</th>
                  <th></th>
                </tr>
                </thead>
               <tbody id ="table4">
              </tbody>
            </table>
            <div class="container text-right">
               <button type="button" class="btn btn-primary" data-toggle="modal" data-target="#add-place-popup" id="add-place-popup-btn" onclick = "initial()"> Add Place </button>

        <div class="modal fade" id="add-place-popup" tabindex="-1" role="dialog" aria-labelledby="add-place-popup-Title" aria-hidden="true">
          <div class="modal-dialog modal-dialog-centered" role="document">
            <div class="modal-content">
              <div class="modal-header">
                <h5 class="modal-title vdark-blue"><b id="ModalTitleF0P0" style="padding-left: 1px;">Add Place</b></h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                  <span aria-hidden="true">&times;</span>
                </button>
              </div>

              <!-- Modal Body for add building -->
              <div class="modal-body" >
                <div class="container-fluid">
                  <!-- First row for building and floor -->
                  <div class="row">
                    <!-- Building -->
                    <div class="col-2 col-sm-2 col-md-2 col-lg-2 col-xl-2">
                      <label for="Capacity"><span class="dark-blue"><b>Building</b></span></label>
                    </div>
                    <div class="col-6 col-sm-6 col-md-6 col-lg-6 col-xl-6">
                      <form>
                        <select id="buildingList" onchange ="changeBuilding()" class="selectpicker">
                        
                        </select>
                      </form>
                    </div>
                     <!-- Floor -->
                    <div class="col-2 col-sm-2 col-md-2 col-lg-2 col-xl-2">
                        <label for="Capacity"><span
                            class="dark-blue"><b>Floor</b></span></label>
                    </div>
                    <div class="col-2 col-sm-2 col-md-2 col-lg-2 col-xl-2">
                      <form>
                        <select id="floorList" onchange="changeFloor()" class="selectpicker">
                        
                        </select>
                      </form>
                    </div>
                  </div>
                  <!-- Second row for building and floor -->
                  <div class="row">
                    <div class="col-1 col-sm-1 col-md-1 col-lg-1 col-xl-1">
                      <label for="Capacity"><span class="dark-blue"><b>Place</b></span></label>
                    </div>
                    <div class="col-11 col-sm-11 col-md-11 col-lg-11 col-xl-11"></div>
                  </div>
                  <div id="placeList">
                    
                  </div>
                </div>
              </div>
              <div class="modal-footer">
                <button onclick="addBuildingRes()" type="button" class="btn btn-primary"
                  id="save" data-dismiss="modal" style="display: block;">
                  <span id="add-place-text">Add</span>
                </button>
              </div>
            </div>
          </div>
        </div>

            </div>
          </div>
          
        </div>
      </div>
    </div>
  </body>


  <script>
  var id = '60070503429'; // initial id
  var buildings;  // all building variable
  var add = new Array();
  var amound;
  
  /** Get all building list **/
  var xmlhttp = new XMLHttpRequest();
  xmlhttp.onreadystatechange = function()
  {
    if (this.readyState == 4 && this.status == 200)
      buildings = JSON.parse(this.responseText);
  };
  xmlhttp.open("GET", "listBuildingRes.php?userId="+id , true);
  xmlhttp.send();


    /** Display table building **/
  var xmlhttp2 = new XMLHttpRequest();
  xmlhttp2.onreadystatechange = function()
  {
    if (this.readyState == 4 && this.status == 200)
    {
      let building_res = JSON.parse(this.responseText);
      let container = document.getElementById("table4");
      let tr_comp;
      let td_comp;
      let new_build = true;
      let new_floor = true;
      let i,j,k;
      let a;
      for (i=0;i<building_res.length;i++)
      {
        tr_comp = document.createElement("tr");
        td_comp = document.createElement("td");
        td_comp.rowSpan = building_res[i].count_place;
        td_comp.innerHTML = building_res[i].building;;
        tr_comp.appendChild(td_comp);
        new_build = true;
        // container.appendChild(tableCon);
        for(j=0; j<building_res[i].floor.length; j++)
        {
          if(new_build)
          {
            td_comp = document.createElement("td");
            new_build = false;
          }
          else
          {
            tr_comp = document.createElement("tr");
            td_comp = document.createElement("td");
          }
          td_comp.rowSpan = building_res[i].floor[j].place.length;
          td_comp.innerHTML = building_res[i].floor[j].floor;
          tr_comp.appendChild(td_comp);
          new_floor = true;
          for(k=0; k< building_res[i].floor[j].place.length; k++)
          {
            if(new_floor)
            {
              td_comp = document.createElement("td");
              new_floor = false;
            }
            else
            {
              tr_comp = document.createElement("tr");
              td_comp = document.createElement("td");
            }
            td_comp.innerHTML = building_res[i].floor[j].place[k].place;
            tr_comp.appendChild(td_comp);
            td_comp = document.createElement("td");
            // <a id="myLink" href="#" onclick="MyFunction();">link text</a>
            a = document.createElement("a");
            a.setAttribute("onclick","confirmDelete("+i+","+j+","+k+")");
            a.innerHTML = "Delete"
            td_comp.appendChild(a);
            tr_comp.appendChild(td_comp);
            container.appendChild(tr_comp);
          }
        }
      } 
    }
  };
  xmlhttp2.open("GET", "getResponsiblePlace.php?userId="+id , true);
  xmlhttp2.send();


  function removeTableBuilding()
  {
    let container = document.getElementById("table4");
    container.querySelectorAll('*').forEach(n => n.remove());
  }
  
  function displayTableBuilding()
  {
    var xmlhttp = new XMLHttpRequest();
    xmlhttp.onreadystatechange = function()
    {
      if (this.readyState == 4 && this.status == 200)
      {
        let building_res = JSON.parse(this.responseText);
        let container = document.getElementById("table4");
        let tr_comp;
        let td_comp;
        let new_build = true;
        let new_floor = true;
        let i,j,k;
        let a;
        for (i=0;i<building_res.length;i++)
        {
          tr_comp = document.createElement("tr");
          td_comp = document.createElement("td");
          td_comp.rowSpan = building_res[i].count_place;
          td_comp.innerHTML = building_res[i].building;;
          tr_comp.appendChild(td_comp);
          new_build = true;
          // container.appendChild(tableCon);
          for(j=0; j<building_res[i].floor.length; j++)
          {
            if(new_build)
            {
              td_comp = document.createElement("td");
              new_build = false;
            }
            else
            {
              tr_comp = document.createElement("tr");
              td_comp = document.createElement("td");
            }
            td_comp.rowSpan = building_res[i].floor[j].place.length;
            td_comp.innerHTML = building_res[i].floor[j].floor;
            tr_comp.appendChild(td_comp);
            new_floor = true;
            for(k=0; k< building_res[i].floor[j].place.length; k++)
            {
              if(new_floor)
              {
                td_comp = document.createElement("td");
                new_floor = false;
              }
              else
              {
                tr_comp = document.createElement("tr");
                td_comp = document.createElement("td");
              }
              td_comp.innerHTML = building_res[i].floor[j].place[k].place;
              tr_comp.appendChild(td_comp);
              td_comp = document.createElement("td");
              // <a id="myLink" href="#" onclick="MyFunction();">link text</a>
              a = document.createElement("a");
              a.setAttribute("onclick","confirmDelete("+i+","+j+","+k+")");
              a.innerHTML = "Delete"
              td_comp.appendChild(a);
              tr_comp.appendChild(td_comp);
              container.appendChild(tr_comp);
            }
          }
        } 
      }
    };
    xmlhttp.open("GET", "getResponsiblePlace.php?userId="+id , true);
    xmlhttp.send();
  }


  /* List option of building */
  function listBuilding()
  {
    let item;
    let buildingContainer = document.getElementById("buildingList");
    for(let i=0; i<buildings.length;i++)
      {
        item = document.createElement("option");
        item.value = buildings[i].building_id;
        item.innerHTML =  buildings[i].building;
        buildingContainer.appendChild(item);
      } 
  }

  function initial()
  {
    removeFloor();
    removePlace();
    listBuilding();
    listFloor();
    listPlace();
  }

  function changeBuilding()
  {
    removeFloor();
    listFloor();
    removePlace();
    listPlace();
  }

  function changeFloor()
  {
    removePlace();
    listPlace();
  }

  /* List option of floor */
  function listFloor()
  {
    // let row = new Array();
    let building_id = document.getElementById("buildingList").value;
    let floorContainer = document.getElementById("floorList");
    let item;
    for(let i=0; i<buildings.length;i++)
    {
      //Print event when it found
      if(buildings[i].building_id == building_id)
      {
        for(let j=0; j<buildings[i].floor.length; j++)
        {
          item = document.createElement("option");
          item.value = buildings[i].floor[j].floor_id;
          item.innerHTML =  buildings[i].floor[j].floor;
          floorContainer.appendChild(item);
        }
        break;
      }
    }
  }

  /* List option of place */
  function listPlace()
  {
    // let row = new Array();
    let building_id = document.getElementById("buildingList").value;
    let floor_id = document.getElementById("floorList").value;
    let placeContainer = document.getElementById("placeList");
    let item;
    for(let i=0; i<buildings.length;i++)
    {
      //Print event when it found
      if(buildings[i].building_id == building_id)
      {
        for(let j=0; j<buildings[i].floor.length; j++)
        {
          if(buildings[i].floor[j].floor_id == floor_id)
          {
            for(let k=0; k<buildings[i].floor[j].place.length; k++)
            {
              check = document.createElement("div");
              check.setAttribute("class","form-check form-check-inline");
              input = document.createElement("input");
              input.setAttribute("class","form-check-input");
              input.setAttribute("type","checkbox");
              input.setAttribute("id","option"+k);
              input.setAttribute("value",buildings[i].floor[j].place[k].place_id);
              if(buildings[i].floor[j].place[k].res)
              {
                input.setAttribute("disabled",'');
                input.setAttribute("checked",'');
              }
              label = document.createElement("label");
              label.setAttribute("class", "form-check-label");
              label.setAttribute("for", "option"+k);
              label.innerHTML = buildings[i].floor[j].place[k].place;
              check.appendChild(input);
              check.appendChild(label);
              placeContainer.appendChild(check);
            }
            break;
          }
        }
        break;
      }
    }
  }

  function removeFloor()
  {
    let floorContainer = document.getElementById("floorList");
    floorContainer.querySelectorAll('*').forEach(n => n.remove());
  }

  function removePlace()
  {
    let placeContainer = document.getElementById("placeList");
    placeContainer.querySelectorAll('*').forEach(n => n.remove());
  }

  function confirmDelete(str)
  {
    let r = confirm("Do you want to delete?");
  }

  function addBuildingRes()
  {
    let building = $("#buildingList").val();
    let floor = $("#floorList").val();
    let placeContainer = document.getElementById("placeList");
    var place = new Array();
    for(let i = 0, max = document.getElementById("placeList").childElementCount; i < max;i++)
    {
      item = document.getElementById("option"+i)
      if(item.checked)
        place.push(item.value)

    }
    place = JSON.stringify(place)
    let ret = '{ "building":"' + building + '",'+
                '"floor":"' + floor + '",' +
                '"place":' + place + ',' +
                '"id":"' + id + '"}'
    json = JSON.parse(ret)
    fetch("addResBuilding.php", {
      method: "POST",
      body: ret
    }).then(async res => {
    removeTableBuilding();
    displayTableBuilding();
    });
  }
  </script>
</html>
